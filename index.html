<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’–å•¡å°å°ç¢°éŠæˆ² - Coffee Expo 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ebb187, #D2691E);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            max-width: 400px;
            width: 100%;
            padding: 20px;
            text-align: center;
        }

        /* é–‹å§‹ç•«é¢ */
        .start-screen {
            display: block;
        }

        .game-screen,
        .result-screen {
            display: none;
        }

        .start-screen h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            line-height: 1.3;
        }

        .start-screen p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .start-btn {
            background: #FF8C00;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* éŠæˆ²ç•«é¢ */
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .card {
            aspect-ratio: 1;
            background: #f5bf99;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid #654321;
        }

        .card.flipped {
            background: #F5DEB3;
            color: #8B4513;
        }

        .card.matched {
            background: #90EE90;
            color: #228B22;
            cursor: default;
            animation: matchPulse 0.6s ease;
        }

        @keyframes matchPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        /* é…å°æˆåŠŸå‹•ç•« */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1000;
            animation: successFade 2s ease-out forwards;
        }

        @keyframes successFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        /* çµæœç•«é¢ */
        .result-screen h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .score-display {
            font-size: 3rem;
            margin: 20px 0;
            font-weight: bold;
        }

        .result-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .restart-btn {
            background: #FF8C00;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.2rem;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        /* è¨ˆæ™‚å™¨æ¨£å¼ */
        .timer {
            color: #FFD700;
        }

        .timer.warning {
            color: #FF4500;
            animation: timerWarning 0.5s infinite alternate;
        }

        @keyframes timerWarning {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é–‹å§‹ç•«é¢ -->
        <div class="start-screen">
            <h1>å¡å¡”æ‘©ç´å°å°ç¢°<br>ç¢°å‡ºå¥½æ‰‹æ°£</h1>
            <p>å¹¸é‹åŠ ä¹˜ï¼Œé¦™æ°£éš¨è¡Œï½</p>
            <button class="start-btn" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
        </div>

        <!-- éŠæˆ²ç•«é¢ -->
        <div class="game-screen">
            <div class="game-info">
                <div class="timer">æ™‚é–“: <span id="time">5</span>ç§’</div>
            </div>
            <div class="game-board" id="game-board"></div>
        </div>

        <!-- çµæœç•«é¢ -->
        <div class="result-screen">
            <h2>éŠæˆ²çµæŸï¼</h2>
            <div class="score-display">åˆ†æ•¸: <span id="final-score">0</span></div>
            <div class="result-message" id="result-message"></div>
        </div>
    </div>

    <script>
        let gameData = {};
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let score = 0;
        let timeLeft = 5;
        let timerInterval;
        let isGamePaused = false;

        // è¼‰å…¥éŠæˆ²è³‡æ–™
        async function loadGameData() {
            try {
                const response = await fetch('./answer.json');
                gameData = await response.json();
                console.log('éŠæˆ²è³‡æ–™è¼‰å…¥æˆåŠŸ:', gameData);
            } catch (error) {
                console.error('è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—:', error);
            }
        }

        // é è¼‰å…¥åœ–ç‰‡
        function preloadImages(imageUrls) {
            return Promise.all(imageUrls.map(url => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(url);
                    img.onerror = () => reject(url);
                    img.src = url;
                });
            }));
        }

        // åˆå§‹åŒ–éŠæˆ²è³‡æ–™
        async function initGame() {
            await loadGameData();
        }

        // å‰µå»ºå¡ç‰Œ
        function createCards() {
            cards = [];
            const regions = Object.keys(gameData).filter(region => region !== 'JOKER'); // æ’é™¤JOKER
            const totalPairs = 8; // 8çµ„é…å° = 16å¼µæ­£å¸¸å¡ç‰Œ

            // éš¨æ©Ÿåˆ†é…çµ„åˆ
            for (let i = 0; i < totalPairs; i++) {
                const randomRegion = regions[Math.floor(Math.random() * regions.length)];
                cards.push({
                    id: i * 2,
                    region: randomRegion,
                    image: gameData[randomRegion].pic,
                    isFlipped: false,
                    isMatched: false,
                    isJoker: false
                });
                cards.push({
                    id: i * 2 + 1,
                    region: randomRegion,
                    image: gameData[randomRegion].pic,
                    isFlipped: false,
                    isMatched: false,
                    isJoker: false
                });
            }

            // æ·»åŠ 4å¼µJOKERå¡ç‰‡
            for (let i = 0; i < 4; i++) {
                cards.push({
                    id: totalPairs * 2 + i,
                    region: 'JOKER',
                    image: gameData['JOKER'].pic,
                    isFlipped: false,
                    isMatched: false,
                    isJoker: true
                });
            }
        }

        // æ´—ç‰Œ
        function shuffleCards() {
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
        }

        // æ¸²æŸ“å¡ç‰Œ
        function renderCards() {
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';

            cards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.dataset.index = index;

                if (card.isMatched) {
                    cardElement.classList.add('matched');
                }

                if (card.isFlipped || card.isMatched) {
                    cardElement.classList.add('flipped');
                    cardElement.innerHTML = `<img src="${card.image}" alt="${card.region}">`;
                } else {
                    cardElement.innerHTML = `<img src="./pic/back.png" alt="å¡ç‰‡èƒŒé¢">`;
                }

                cardElement.addEventListener('click', () => handleCardClick(index));
                gameBoard.appendChild(cardElement);
            });
        }

        // è™•ç†å¡ç‰Œé»æ“Š
        function handleCardClick(index) {
            if (isGamePaused) return;

            const card = cards[index];

            // é˜²æ­¢é»æ“Šå·²ç¿»é–‹æˆ–å·²åŒ¹é…çš„å¡ç‰Œ
            if (card.isFlipped || card.isMatched) return;

            // é˜²æ­¢åŒæ™‚ç¿»é–‹è¶…é2å¼µå¡ç‰Œ
            if (flippedCards.length >= 2) return;

            card.isFlipped = true;
            flippedCards.push(card);
            renderCards();

            // æª¢æŸ¥æ‰€æœ‰å·²ç¿»é–‹çš„ç‰Œä¸­æ˜¯å¦æœ‰ Joker
            const hasJoker = flippedCards.some(card => card.isJoker);

            if (hasJoker) {
                // å¦‚æœæœ‰ Jokerï¼Œç«‹å³è™•ç†ï¼ˆç„¡è«–æ˜¯ç¬¬ä¸€å¼µé‚„æ˜¯ç¬¬äºŒå¼µï¼‰
                isGamePaused = true; // é˜²æ­¢åœ¨è“‹èµ·æœŸé–“ç¿»å…¶ä»–å¡ç‰‡
                setTimeout(() => {
                    flippedCards.forEach(card => card.isFlipped = false);
                    flippedCards = [];
                    renderCards();
                    isGamePaused = false; // æ¢å¾©éŠæˆ²
                }, 500);
                return;
            }

            if (flippedCards.length === 2) {
                setTimeout(checkMatch, 500);
            }
        }

        // æª¢æŸ¥æ˜¯å¦åŒ¹é…
        function checkMatch() {
            const [card1, card2] = flippedCards;

            // å¦‚æœä»»ä¸€å¼µå¡ç‰‡æ˜¯JOKERï¼Œé…å°ä¸æˆåŠŸ
            if (card1.isJoker || card2.isJoker) {
                // åŒ¹é…å¤±æ•— - å…©å¼µä¸€èµ·è“‹èµ·
                isGamePaused = true; // é˜²æ­¢åœ¨è“‹èµ·æœŸé–“ç¿»å…¶ä»–å¡ç‰‡
                setTimeout(() => {
                    card1.isFlipped = false;
                    card2.isFlipped = false;
                    flippedCards = [];
                    renderCards();
                    isGamePaused = false; // æ¢å¾©éŠæˆ²
                }, 500);
                return; // æå‰è¿”å›ï¼Œä¸åŸ·è¡Œå¾Œé¢çš„é‚è¼¯
            } else if (card1.region === card2.region) {
                // åŒ¹é…æˆåŠŸ - ç«‹å³çµæŸéŠæˆ²
                card1.isMatched = true;
                card2.isMatched = true;
                matchedPairs++;

                // é¡¯ç¤ºæˆåŠŸå‹•ç•«ä¸¦çµæŸéŠæˆ²
                showSuccessAnimation(card1.region);
                setTimeout(() => {
                    endGame(card1.region);
                }, 2000);
            } else {
                // åŒ¹é…å¤±æ•— - å…©å¼µä¸€èµ·è“‹èµ·
                isGamePaused = true; // é˜²æ­¢åœ¨è“‹èµ·æœŸé–“ç¿»å…¶ä»–å¡ç‰‡
                setTimeout(() => {
                    card1.isFlipped = false;
                    card2.isFlipped = false;
                    flippedCards = [];
                    renderCards();
                    isGamePaused = false; // æ¢å¾©éŠæˆ²
                }, 500);
                return; // æå‰è¿”å›ï¼Œä¸åŸ·è¡Œå¾Œé¢çš„é‚è¼¯
            }
        }

        // é¡¯ç¤ºæˆåŠŸå‹•ç•«
        function showSuccessAnimation(region) {
            isGamePaused = true;

            const animation = document.createElement('div');
            animation.style.textAlign = 'center';
            animation.className = 'success-animation';
            animation.innerHTML = `${region}<br>é…å°æˆåŠŸï¼`;
            document.body.appendChild(animation);

            setTimeout(() => {
                document.body.removeChild(animation);
                isGamePaused = false;
            }, 2000);
        }

        // æ›´æ–°åˆ†æ•¸
        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        // é–‹å§‹éŠæˆ²
        async function startGame() {
            // é¡¯ç¤ºè¼‰å…¥æç¤º
            const startBtn = document.querySelector('.start-btn');
            startBtn.disabled = true;
            startBtn.textContent = 'è¼‰å…¥ä¸­...';

            // å…ˆè¼‰å…¥éŠæˆ²è³‡æ–™
            await loadGameData();

            // æ”¶é›†æ‰€æœ‰éœ€è¦çš„åœ–ç‰‡URL
            const imageUrls = [
                './pic/back.png', // å¡ç‰‡èƒŒé¢
                ...Object.values(gameData).map(region => region.pic) // æ‰€æœ‰å’–å•¡ç”¢åœ°åœ–ç‰‡
            ];

            try {
                // é è¼‰å…¥æ‰€æœ‰åœ–ç‰‡
                await preloadImages(imageUrls);
                console.log('æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œæˆ');
            } catch (error) {
                console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—:', error);
                // å³ä½¿è¼‰å…¥å¤±æ•—ä¹Ÿè¦ç¹¼çºŒéŠæˆ²
            }

            // éš±è—é–‹å§‹ç•«é¢ï¼Œé¡¯ç¤ºéŠæˆ²ç•«é¢
            document.querySelector('.start-screen').style.display = 'none';
            document.querySelector('.game-screen').style.display = 'block';

            // åˆå§‹åŒ–éŠæˆ²
            createCards();
            shuffleCards();
            renderCards();

            // é–‹å§‹è¨ˆæ™‚å™¨
            startTimer();
        }

        // é–‹å§‹è¨ˆæ™‚å™¨
        function startTimer() {
            const timerElement = document.getElementById('time');

            timerInterval = setInterval(() => {
                if (!isGamePaused) {
                    timeLeft--;
                    timerElement.textContent = timeLeft;

                    if (timeLeft <= 3) {
                        timerElement.parentElement.classList.add('warning');
                    }

                    if (timeLeft <= 0) {
                        endGame();
                    }
                }
            }, 1000);
        }

        // çµæŸéŠæˆ²
        function endGame(wonRegion = null) {
            clearInterval(timerInterval);

            document.querySelector('.game-screen').style.display = 'none';
            document.querySelector('.result-screen').style.display = 'block';

            const resultTitle = document.querySelector('.result-screen h2');
            const scoreDisplay = document.querySelector('.score-display');
            const resultMessage = document.getElementById('result-message');

            if (wonRegion) {
                // ç²å¾—çé …
                resultTitle.textContent = 'ğŸ‰ æ­å–œä¸­çï¼';
                scoreDisplay.style.display = 'none';
                resultMessage.innerHTML = `æ­å–œç²å¾—<strong>${wonRegion}</strong>æ¿¾æ›å’–å•¡ 1 åŒ…`;
                resultMessage.style.fontSize = '1.5rem';
                resultMessage.style.fontWeight = 'bold';
                resultMessage.style.color = '#FFD700';
            } else {
                // æ™‚é–“çµæŸï¼Œæœªä¸­ç
                resultTitle.textContent = 'éŠ˜è¬æƒ é¡§';
                scoreDisplay.style.display = 'none';
                resultMessage.innerHTML = `å·®ä¸€é»å°±ä¸­å•¦ï½<br><br>åˆ¥é›£éï¼è‡³å®˜ç¶²æ¶ˆè²»æ™‚è¼¸å…¥æŠ˜æ‰£ç¢¼ï¼Œç…§æ¨£äº«æœ‰ $25 æŠ˜æ‰£ ğŸ<br><br><strong style="font-size: 1.3rem; color: #FFD700;">æŠ˜æ‰£ç¢¼ï¼šCOFFEE2025</strong>`;
                resultMessage.style.fontSize = '1.2rem';
                resultMessage.style.lineHeight = '1.6';
            }
        }


        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = initGame;
    </script>
</body>
</html>
